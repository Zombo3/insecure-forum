<section>
  <h1>Welcome to the Zombo3 Zone</h1>
  <p>Post comments, read the feed, and later we'll analyze all the security problems.</p>
  <p><a class="btn" href="/comments">Go to Feed</a></p>

  <figure class="hero">
    <img src="/static/img/zombo3.png" alt="Logo">
  </figure>
</section>

<hr>

<section style="margin-top: 24px;">
  <h2>Real-time Chat</h2>

  <div
    id="chatBox"
    style="border:1px solid #ccc; padding:12px; height:220px; overflow:auto; margin-bottom:8px;"
  >
    <div><em>Chat connected. Say something…</em></div>
  </div>

  <form id="chatForm">
    <input
      id="chatInput"
      name="text"
      type="text"
      placeholder="Type a message…"
      style="width:70%;"
      autocomplete="off"
    />
    <button type="submit">Send</button>
  </form>
</section>

<script>
  // IMPORTANT: wait until the full page is parsed (so main.hbs has created window.socket)
  window.addEventListener('DOMContentLoaded', () => {
    const chatBox = document.getElementById('chatBox');
    const chatForm = document.getElementById('chatForm');
    const chatInput = document.getElementById('chatInput');

    const sock = window.socket;
    if (!sock) {
      console.log('chat: no socket available');
      return;
    }

    function addMsg(line) {
      const div = document.createElement('div');
      div.textContent = line;
      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    // Load chat history on connect
    sock.on('chat:history', (messages) => {
      // Clear the initial "Chat connected..." line
      chatBox.innerHTML = '';
      for (const msg of messages) {
        addMsg(`${msg.user}: ${msg.message || msg.text}`);
      }
    });

    // Live messages
    sock.on('chat:message', (msg) => {
      addMsg(`${msg.user}: ${msg.message || msg.text}`);
    });

    chatForm.addEventListener('submit', (e) => {
      e.preventDefault();
      const text = chatInput.value;
      if (!text.trim()) return;
      sock.emit('chat:send', { text });
      chatInput.value = '';
    });
  });
</script>
